let $=jQuery,$win=$(window);import e from"./lame.min.js";let{Mp3Encoder:t}=e,notes=[],ctx=new AudioContext;function addCompressor(e){(e.limiter=new DynamicsCompressorNode(e,{ratio:17,knee:8,threshold:ctx==e?-16:-12,release:.1})).connect(new GainNode(e,{gain:1.65})).connect(e.destination)}function playBuffer(e,t,a=ctx){if(a==ctx&&"running"!=ctx.state){ctx.resume().then(()=>playBuffer(e,t));return}let{buffer:r,i:n}=e,l=new AudioBufferSourceNode(a,{buffer:r}),c=new GainNode(a,{gain:6==n?.25:.35});if(n?l.connect(c).connect(a.limiter):l.connect(a.destination),e.source?.context==a){let{gain:o}=e.gain,s=(a.currentTime||t)+.03;t&&o.setValueAtTime(o.value,t),o.linearRampToValueAtTime(0,s),e.source.stop(s)}Object.assign(e,{source:l,gain:c}),l.start(t),$(l).on("ended",t=>{l.disconnect(),c.disconnect(),e.source==l&&delete e.source})}async function saveRecord(e,a="kosmosky"){let r=e.reduce((e,t)=>{let[a,r]=t.split(":");return Math.max(e,r/1e3+notes[a].buffer.duration)},0)+.1,n=new OfflineAudioContext(1,48e3*r,48e3);addCompressor(n);let l=new t(1,48e3,128);e.forEach(e=>{let[t,a]=e.split(":");playBuffer(notes[t],a/1e3+.1,n)}),n.startRendering().then(e=>{let t=e.getChannelData(0),r=t.reduce((e,t)=>Math.max(e,Math.abs(t)),0);console.log(r),t.forEach((e,a)=>t[a]=32767*e/r);let n=[];setTimeout(async function e(){if(t.length)setTimeout(e),n.push(l.encodeBuffer(t.subarray(0,11520))),t=t.subarray(11520);else{n.push(l.flush());var r=new Blob(n,{type:"audio/mp3"}),c=window.URL.createObjectURL(r);jQuery("<a>").prop({href:c,download:a+".mp3"})[0].click()}})})}addCompressor(ctx),window.saveRecord=saveRecord;let gamma=[];for(let i=0;i<15;i++)gamma[i]=i+1+":"+500*i;function url(e){return new URL(e,import.meta.url).href}console.log(gamma);let container=$("#hdrum-vidget");function play(e){if(!notes[e])return;let{$petal:t,timer:a}=notes[e];playBuffer(notes[e]),t.addClass("active"),clearTimeout(a),notes[e].timer=setTimeout(()=>{t.removeClass("active")},100),recording&&record(e)}container.children()[0]||container.html(await $.get(url("hdrum.html")));let startRec;function record(e){let t=1e3*ctx.currentTime;localStorage[recId]?localStorage[recId]+=",":startRec=t,localStorage[recId]+=`${e}:${Math.round(t-startRec)}`}$(".hd-drum>svg").clone().addClass("hd-drum2").appendTo(".hd-drum").find("filter").remove();let loading=[],keys="01234567QWERTYUI";$win.keydown(e=>{e.originalEvent.repeat||play("01234567QWERTYUI".indexOf(e.code.at(-1)))});let $petals=$("[data-petal]").each((e,t)=>{$(t).closest(".hd-drum2")[0]||$("path",t).clone().prependTo(t).addClass("hd-white");let a=+t.dataset.petal;if(notes[a])return;let r=$(`[data-petal="${a}"]`);notes[a]={$petal:r,i:e},loading.push(fetch(url(`notes/${a||"tuk"}.mp3`)).then(e=>e.arrayBuffer()).then(e=>ctx.decodeAudioData(e)).then(e=>notes[a].buffer=e)),r.on("pointerdown",function(e){$(".hd-controls button").mouseleave(),play(a);let t=a;this.setPointerCapture(e.pointerId),$(this).on("pointermove",function(e){let a=$(document.elementFromPoint(e.clientX,e.clientY)).closest("[data-petal]")[0],r=a?.dataset.petal;r!=t&&r>0&&($petals.removeClass("hover").find(`[data-petal="${r}"]`).addClass("hover"),play(r),t=r)})}).on("pointerenter",e=>{r.addClass("hover")}).on("pointerleave",e=>{$petals.removeClass("hover")})}).on("touchstart selectstart",e=>e.preventDefault());$win.on("pointerup pointercancel blur",e=>{$petals.off("pointermove")}),Promise.all(loading).then(()=>console.log("all notes loaded"));let recording=0,start,trackId,track,recId,playing,trackTimers=[],$rec=$(".hd-rec").on("click",e=>{recording^=1,$rec.toggleClass("hd-active");let t=localStorage.hdTracks||"",a=t.split(",").length;recording?(recId="hd_record_melody"+a,trackId="",localStorage[recId]=""):localStorage[recId]?(localStorage.hdTracks=t+(a?",":"")+recId,setTrack(recId)):(delete localStorage[recId],setTrack())}),$play=$(".hd-play").on("click",e=>{if(playing^=1,$play.toggleClass("hd-active"),playing){track==gamma&&$gamma.addClass("active"),trackTimers=[];let t=timeline.value;t==timeline.max&&setTime(t=0),start=1e3*ctx.currentTime-t,track.forEach((e,a,{length:r})=>{let[n,l]=e.split(":");(l-=t)?l>0&&trackTimers.push(setTimeout(()=>{play(n)},l)):play(n),1==r&&$play.click()})}else trackTimers.forEach(e=>clearTimeout(e)),track==gamma&&trackId&&setTrack(),$gamma.removeClass("active")});function setTrack(e=trackId){if(e){if(e!=gamma&&!(e in localStorage)){console.warn(`melody ${e} does not exist!`);return}e!=gamma&&(trackId=localStorage.lastTrack=e),window.curTrack=track=localStorage[e]?.split(",")||gamma,timeline.max=+/\d+$/.exec(track.at(-1))+100,setTime(0),(track!=gamma||$player.is(".hd-visible"))&&$(".hd-bottom>*").toggleClass("hd-visible")}}let $player=$(".hd-player"),$timeline=$(".hd-timeline input").on("input",setTime).prop({min:0}),timeline=$timeline[0];function setTime(e){isNaN(e)||(timeline.value=Math.min(e,timeline.max));let{min:t,max:a,value:r}=timeline;this==timeline&&(playing&&+r+this.lastVal&&$play.click().click(),this.lastVal=+r),playing&&r==a&&($play.click(),track==gamma&&setTrack()),timeline.parentNode.style.setProperty("--progress",(r-t)/(a-t)*100+"%")}let $gamma=$(".hd-gamma").click(function(e){$gamma.addClass("clicked");let t=track==gamma;(playing||t)&&$play.click(),t||(setTrack(gamma),$play.click())}).on("mouseleave",e=>$gamma.removeClass("clicked"));$(".hd-close").click(e=>{trackId="",$(".hd-bottom>*").toggleClass("hd-visible")}),requestAnimationFrame(function e(){requestAnimationFrame(e),playing&&setTime(1e3*ctx.currentTime-start)});let $share=$(".hd-share").click(e=>saveRecord(track));$win.on("blur",e=>{recording&&$rec.click()}),[..."ABDFACEFDBGEC"].forEach((e,t)=>{$('<b class="hd-tag">'+e.replace(/F/g,"F<sub>#</sub>")+"</b>").css({"--rot":t/13+"turn"}).prependTo(".hd-drum")}),"235791113141210864".match(/1?./g).forEach((e,t)=>{$(`<b class="hd-tag-n hd-n${t+2}">${e}</b>`).prependTo(".hd-drum")});